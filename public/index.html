<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>QualiFi</title>
	<link rel="stylesheet" href="qualifi.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	<script>
		// Dynamic font loading - try Berkeley Mono first, fallback to Poppins
		(function() {
			// Function to check if a font is available
			function checkFont(fontName) {
				const testString = 'abcdefghijklmnopqrstuvwxyz0123456789';
				const testSize = '72px';
				const fallbackFont = 'monospace';

				const canvas = document.createElement('canvas');
				const context = canvas.getContext('2d');

				context.font = testSize + ' ' + fallbackFont;
				const fallbackWidth = context.measureText(testString).width;

				context.font = testSize + ' ' + fontName + ', ' + fallbackFont;
				const testWidth = context.measureText(testString).width;

				return testWidth !== fallbackWidth;
			}

			// Function to load Poppins from Google Fonts
			function loadPoppins() {
				if (!document.querySelector('link[href*="fonts.googleapis.com"]')) {
					const link = document.createElement('link');
					link.rel = 'preconnect';
					link.href = 'https://fonts.googleapis.com';
					document.head.appendChild(link);

					const link2 = document.createElement('link');
					link2.rel = 'preconnect';
					link2.href = 'https://fonts.gstatic.com';
					link2.crossOrigin = 'anonymous';
					document.head.appendChild(link2);

					const link3 = document.createElement('link');
					link3.href = 'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap';
					link3.rel = 'stylesheet';
					document.head.appendChild(link3);
				}
			}

			// Store font preference globally
			window.QUALIFI_FONT = 'Berkeley Mono';

			// Wait for DOM and fonts to load
			document.addEventListener('DOMContentLoaded', function() {
				// Give Berkeley Mono a moment to load if it's available
				setTimeout(function() {
					if (!checkFont('Berkeley Mono')) {
						console.log('Berkeley Mono not found, falling back to Poppins');
						window.QUALIFI_FONT = 'Poppins';
						loadPoppins();

						// Update CSS custom property for dynamic font switching
						document.documentElement.style.setProperty('--primary-font', 'Poppins');
						document.documentElement.style.setProperty('--chart-font', "'Poppins', sans-serif");
					} else {
						console.log('Berkeley Mono detected and loaded');
						document.documentElement.style.setProperty('--primary-font', 'Berkeley Mono');
						document.documentElement.style.setProperty('--chart-font', "'Berkeley Mono', monospace");
					}

					// Trigger a custom event that the main JS can listen for
					window.dispatchEvent(new CustomEvent('fontLoaded', { detail: { font: window.QUALIFI_FONT } }));
				}, 500);
			});
		})();
	</script>
</head>
<body>
	<header>
		<div class="container">
			<div class="header-content">
				<img src="skunk.png" alt="Skunk Logo" class="header-logo" onerror="this.style.display='none'">
				<div class="header-text">
					<h1>QualiFi</h1>
					<p class="subheader">SDG RvR Analyzer</p>
				</div>
			</div>
		</div>
	</header>

	<div class="container">
		<div class="control-panel">
			<div class="source-tabs">
				<button class="tab-button active" onclick="switchTab('server')">
					<span class="tab-icon">‚òÅÔ∏è</span> Server Reports
				</button>
				<button class="tab-button" onclick="switchTab('local')">
					<span class="tab-icon">üìÅ</span> Local Files
				</button>
			</div>

			<div class="tab-content" id="serverTab">
				<div class="search-bar">
					<input type="text" id="reportSearch" placeholder="Search vendors, models, or versions..."
						   oninput="searchReports(this.value)">
					<button class="btn-small" onclick="refreshReports()">üîÑ Refresh</button>
				</div>

				<div class="quick-filters" style="margin-bottom: 15px;">
					<span style="color: #888; margin-right: 10px;">Quick filters:</span>
					<button class="btn-small" onclick="expandAllVendors()">Expand All</button>
					<button class="btn-small" onclick="collapseAllVendors()">Collapse All</button>
					<button class="btn-small" onclick="selectLatestVersions()">Select Latest Versions</button>
				</div>

				<div class="report-browser" id="reportBrowser">
					<div class="loading">Loading server reports...</div>
				</div>

				<div class="selected-reports" id="selectedReports" style="display: none;">
					<h4 style="margin: 15px 0 10px 0; color: #aaa;">Selected Reports:</h4>
					<div id="selectedReportsList"></div>
					<button class="chart-button" style="margin-top: 15px;" onclick="loadSelectedReports()">
						Load Selected Reports
					</button>
				</div>
			</div>

			<div class="tab-content" id="localTab" style="display: none;">
				<div class="file-selector">
					<label for="excelFile">Upload Excel Test Reports:</label>
					<div class="file-input-wrapper">
						<input type="file" id="excelFile" accept=".xlsx,.xls" multiple>
						<label for="excelFile" class="file-input-label">
							üìÅ Click to select Excel files or drag & drop here<br>
							<span style="font-size: 0.85em; color: #888;">Load multiple files to compare different devices</span>
						</label>
					</div>
				</div>
			</div>

			<div class="file-list" id="fileList">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
					<h4 style="color: #aaa; margin: 0;">
						Loaded Reports:
						<span id="fileCount" style="color: #00a0c8;">0 files from 0 devices</span>
					</h4>
					<div style="display: flex; gap: 10px;">
						<button class="btn-small" onclick="clearServerFiles()">Clear Server</button>
						<button class="btn-small" onclick="clearLocalFiles()">Clear Local</button>
						<button class="btn-small" onclick="clearAllFiles()" style="background: rgba(220, 38, 38, 0.2); border: 1px solid rgba(220, 38, 38, 0.3);">
							Clear All
						</button>
					</div>
				</div>
				<div id="fileItems"></div>
			</div>

			<div class="test-selector" style="display: none;">
				<h3>Select Test Configurations to Compare:</h3>
				<div id="filterNotice" style="display: none; background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); padding: 10px; border-radius: 6px; margin-bottom: 15px; color: #ffc107; font-size: 0.9em;">
					‚ö†Ô∏è Invalid data points (channel=0 or throughput=0) have been automatically filtered out<br>
					‚ÑπÔ∏è DUT-TX tests use TX-specific columns (TX BW, TX NSS, TX Mode) when available<br>
					‚ÑπÔ∏è DUT-RX tests use RX-specific columns (RX BW, RX NSS, RX Mode) when available
				</div>
				<div class="test-options" id="testOptions"></div>
			</div>
		</div>

		<div class="chart-container" style="display: none;">
			<div class="chart-controls">
				<button class="chart-button" onclick="toggleChartType()">Toggle Chart Type</button>
				<button class="chart-button" onclick="exportChart()">Export Chart</button>
				<button class="chart-button" onclick="resetZoom()">Reset Zoom</button>
				<button class="chart-button" onclick="exportComparison()">Export Comparison</button>
			</div>
			<canvas id="rvrChart"></canvas>
		</div>

		<div class="stats-panel" style="display: none;">
			<h3 style="margin-bottom: 20px; color: #00a0c8;">Performance Statistics</h3>
			<div class="stats-grid" id="statsGrid"></div>
		</div>

		<div class="comparison-panel" style="display: none;" id="comparisonPanel">
			<h3 style="margin-bottom: 20px; color: #00a0c8;">Device Comparison Summary</h3>
			<div id="comparisonTable"></div>
		</div>
	</div>

	<script src="qualifi.js"></script>
</body>
</html>
